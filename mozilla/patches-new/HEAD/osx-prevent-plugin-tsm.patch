diff

A patch to tweak Mozilla keyboard event handle for plugins so that
Komodo's SciMoz plugin works as we need. At least the second hunk here
(in `performKeyEquivalent:`) is to prevent Mozilla from special casing
plugins to NOT handle some keyboard events.

Index: widget/src/cocoa/nsChildView.mm
===================================================================
RCS file: /cvsroot/mozilla/widget/src/cocoa/nsChildView.mm,v
retrieving revision 1.370
diff -u -r1.370 widget/src/cocoa/nsChildView.mm
--- widget/src/cocoa/nsChildView.mm	29 Sep 2009 19:43:54 -0000	1.370
+++ widget/src/cocoa/nsChildView.mm	27 Oct 2009 19:53:22 -0000
@@ -5237,6 +5237,9 @@
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
+/* XXX ACTIVESTATE: allowing TSM to be used on a plugin prevents keyPress
+                    events, thus breaking our use of SciMoz.
+                    
   // If a plugin has the focus, we need to use an alternate method for
   // handling NSKeyDown and NSKeyUp events (otherwise Carbon-based IME won't
   // work in plugins like the Flash plugin).  The same strategy is used by the
@@ -5256,6 +5259,7 @@
     return;
   }
 
+*/
 #ifdef MOZ_MACBROWSER
   PRBool handled = [self processKeyDownEvent:theEvent keyEquiv:NO];
   if (!handled) {
@@ -5458,7 +5462,10 @@
     //
     // If this is a plugin, we do actually perform the action on keyboard commands. See bug 428047.
     // If the action on plugins here changes the first responder, don't continue.
-    if (mIsPluginView) {
+    //
+    // ACTIVESTATE KOMODO: Always let Komodo's scimoz plugin handle the
+    // keyboard event (see Komodo bug 82895).
+    if (false && mIsPluginView) {
       [(GeckoNSMenu*)mainMenu actOnKeyEquivalent:theEvent];
       if ([[self window] firstResponder] != self)
         return YES;
@@ -5488,10 +5495,13 @@
   // happen if we return NO here. This only applies to Mac OS X 10.5 and higher,
   // previous OS versions just call "keyDown:" and not "performKeyEquivalent:"
   // for such events.
+  // ACTIVESTATE: This is causing Komodo's Ctrl+ and Alt+ menu commands to fail,
+  //              so removing this code. See Komodo bug 78266.
+  /*
   if (!keyDownNeverFiredEvent &&
       (modifierFlags & (NSControlKeyMask | NSAlternateKeyMask)))
     return handledByEmbedding;
-
+  */
   if ([theEvent type] == NSKeyDown) {
     // We trust the Gecko handled status for cmd key events. See bug 417466 for more info.
     if (modifierFlags & NSCommandKeyMask)
